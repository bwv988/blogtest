---
title: Downloading an F4F Media Stream with some help from Koding.com
categories: [linux]
layout: post
---

## Introduction

Recently I was preparing for a flight the following day and wanted to download a lecture video for a university course I am doing at the moment, so that I would be able to watch the lecture while airborne.

But this turned out to be much trickier than I had anticipated!

I quickly had to come to terms with the fact that none of my go-to streaming downloaders was able to help me, so I had to quickly research an alternative.

After some further digging, it turned out the streaming platform the university runs is based on _F4F fragmented streaming_. F4F is a file format used by _Adobe Media Server_ to essentially deliver an FLV video in small chunks over the internet. As a consequence, videos cannot be downloaded directly; instead all the chunks need to be downloaded individually and re-assembled after all chunks were fully retrieved.

Luckily, this came up in a in a post on Slashdot not too long ago (see [Slashdot post](http://stackoverflow.com/questions/25425956/any-good-programs-for-handeling-f4f-fragments-and-converting-them-into-a-complet) for more), and somebody has already written a neat little script to do exactly that job of re-assembling the stream fragments.

The script can be run fairly easily on a Linux environment and, with some extra, work possibly also on Windows or Mac OSX.

So the following is a step-by-step tutorial on applying the methodology outlined in the post. I have tried to be as concise as possible so as to make it easy to follow, even if you're not familiar with Linux.

## Pre-requisites

For this quick tutorial, I have decided to demo the steps involved on a virtual machine running Linux which is hosted in __Koding__: [https://koding.com/](https://koding.com/).

Why? Firstly because I love Koding and secondly because I can do whatver I like in my blog!

But all joking aside, Koding is actually a brilliant project which provides a web-based IDE, collaborative ("social") coding, and full (yes, that means `root` for all the geeks out there) access to your very __own__ Ubunutu Linux installation in the cloud, and all that through the browser. This means you are totally free to play with the VM, create, install, play, delete whatever you wish (just don't do anything harmful, please :-)

Oh yeah, it's also completely free of charge.

Isn't that pretty cool??

Simply register for Koding and you're ready to move on to the first step. Or run the below steps on your Linux box, VM, etc.


## 1. Download the script

After you have familiarized yourself a bit with the Koding environment (they have some pretty good quickstart HOW-TOs), fire up your virtual machine instance. This should automatically open a terminal session, so in your browser you will see the command line as in the below picture:

![Step 1](/images/f4fpost/step1.png)

If you get this far, well done! ;-) Now you have access to the full power of _Ubuntu Linux_. Awesome.

The first thing I'm going to do is to create a new directory and use `git` to check out the script's sources from _GitHub_:

    mkdir video_downloads
    cd video_downloads
    git clone https://github.com/K-S-V/Scripts.git

This will be our working directory, so we keep things nice and tidy. I like to keep things nice and tidy.

## Step 2. Install missing dependencies

Your terminal session should look more or less as in the picture below:

![Step 2a](/images/f4fpost/step2a.png)

Note that there is now a `Scripts` folder, and when you change to that folder using the Linux `cd` command, you will find a file called `AdobeHDS.php`. The file ending tells you that the script is written in PHP, and this is the script that's going to do all the hard work for us!

    cd Scripts

If you now attempt to run the script _as is_, you'll quickly notice there is something wrong:

    php AdobeHDS.php

The output will look something like:


                KSV Adobe HDS Downloader

    You have to install the following extension(s) to continue: 'curl'

But that's easily fixed. We simply use the `apt-get` command in Ubuntu to install a new software package:

    sudo apt-get install php5-curl

![Step 2b](/images/f4fpost/step2b.png)

Now all is good and we can check that by issuing a quick

    php AdobeHDS.php --help

which shows all of the script's command line options. Great. let's move on so.

## 3. Locating the stream manifest
For every FLV video that is delivered through F4F chunks, there exists a so-called __stream manifest__ file that captures certain technical details of the stream, i.e. quality, length etc., but most importantly the number of chunks, in a machine-readable format.

Our task is to locate the manifest file, because it's what the script requires as an input.

So now we need to do the following:

1. Open the web page containing the video you wish to download.
2. Open the browser's developer console. Dont' worry, we are not going to break anything, I promise! :-D In Google Chrome this can be achieved either through the menu or by pressing `Ctrl+Shift+I` simultaneously.
3. In the network tab of the developer console, locate for the manifest. You'll recognize it once you see it, because the response type is XML.
4. Copy the link to this file by right-clicking on the name and selecting "Copy Link Address".

Below picture shows an example of how this could look like, highlighting the relevant parts:

![Step 3a](/images/f4fpost/step3a.png)

The link you have just copied could look like this:

    https://media.heanet.ie/vod/8dc0b92c3a613889748f7dc3b4f0eab6/8dc0b92c3a613889748f7dc3b4f0eab6.f4m?SUID=9fc4c10ac54c43b144bbb6082bc92f0c

Your link will of course be totally different from the one I got.

## 4. Downloading the video

Now we can finally download the video, yay!

I am moving out of the current directory and then I call the script with the manifest file as an input parameter:

    cd ..
    php Scripts/AdobeHDS.php --manifest https://media.heanet.ie/vod/8dc0b92c3a613889748f7dc3b4f0eab6/8dc0b92c3a613889748f7dc3b4f0eab6.f4m?SUID=195127d33c98c1d9d32842895655b92d

The download starts, a lot of files are being downloaded, and eventually we get the below output:

    ternaryrealm: ~/video_downloads $ php Scripts/AdobeHDS.php --manifest https://media.heanet.ie/vod/8dc0b92c3a613889748f7dc3b4f0eab6/8dc0b92c3a613889748f7dc3b4f0eab6.f4m?SUID=195127d33c98c1d9d32842895655b92d

                        KSV Adobe HDS Downloader

    Processing manifest info....
    Quality Selection:
    Available: 3368 2202 1569 1141 938 646 470
    Selected : 3368
    Fragments Total: 495, First: 1, Start: 1, Parallel: 8
    Downloading 495/495 fragments
    Found 396 fragments
    Finished
    ternaryrealm: ~/video_downloads $

Cool. Now run the following command and it will locate the filename of the __complete video file__:

    ls *.flv
    e6aaf925d6259bd139c6f53ba4af87dd_fbd5bb249733a6fae16ca0a309d676b5_Seg1-Frag.flv

This filename looks a bit messy, thus I am going to rename it and move it into a different folder (the `Web` folder actually) so I will be able to download it from the Koding VM:

    mv e6aaf925d6259bd139c6f53ba4af87dd_fbd5bb249733a6fae16ca0a309d676b5_Seg1-Frag.flv ~/Web/video1.flv

By the way, don't bother typing that full name. Just type `e6` and press the `Tab` button on your keyboard and add the `.flv` extension.

Magic!

Of course you will have to replace that `e6` by whatever letters your file name starts with!

## 5. Download the video from Koding

All that is left to do now is to download the video file from Koding. That's the easiest part.

You may not have realized, but your VM already has a __public URL__ on the internet. And because we have moved the finished video file into the `Web` folder, we can now proceed to download it (anything that is in the Web folder can be downloaded over the internet) using that URL.

1. In your browser window, on the left-hand pane locate the "YOUR VMS" section at the top.
2. When hovering the mouse over the VM name, a little menu button is revealed. Click that button.
3. This will bring up a dialog window, which, among other things, shows the public URL of the VM. Simply click on that link. This will open a new browser tab.

Here are screenshots for the steps described above:

![Step 4b](/images/f4fpost/step4b.png)

![Step 4c](/images/f4fpost/step4c.png)

Now you can download the video by adding the filename `video1.flv` to the URL:

![Step 4d](/images/f4fpost/step4d.png)

Press enter and the download starts!

## 6. Cleanup

As you know, I like to keep things nice and tidy, so finally let's remove all the downloaded stuff on your Koding VM, or you may eventually run out of disk space:

    ternaryrealm: ~/video_downloads $ rm e6*
    ternaryrealm: ~/video_downloads $ rm ~/Web/video1.flv
    ternaryrealm: ~/video_downloads $  


That's it, enjoy!
