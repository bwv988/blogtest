<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Downloading an F4F Media Stream with some help from Koding.com</title>
  <meta name="description" content="Data, Code and Stuff">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.warpbreaks.io/linux/2015/06/30/dlf4f.html">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">warpbreaks.io</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about.html">About</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/archive.html">Archive</a>
          
        
      </div>

      <div id="logo_fixed">
          <img src="/images/fern.png"></img>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Downloading an F4F Media Stream with some help from Koding.com</h1>
    <p class="post-meta">Jun 30, 2015</p>
  </header>

  <article class="post-content">
    <h2 id="introduction">Introduction</h2>

<p>Recently I was packing for a flight I was due to take the following day and wanted to download a lecture video for a university module I am doing at the moment. My plan was to kill some time during flight and watch the lecture while cruising at 30.000 feet.</p>

<p>But this turned out to be much trickier than I had anticipated!</p>

<p>After some initial attempts I gave up and quickly had to come to terms with the fact that none of my trusty downloading tools was able to help me this time. I put the search for and alternative  off for later and enjoyed a nice movie on the plane instead. Not so bad.</p>

<p>Today I was finally able to do some further digging, and I found that the underlying streaming platform the university runs is based on <em>F4F fragmented streaming</em>. F4F is a file format served by <em>Adobe Media Server</em>. The core idea of this product is to cut up and deliver an FLV video in small chunks over the internet. As a consequence, videos cannot be downloaded directly – instead all the chunks are downloaded individually by the browser and re-assembled on the client side, usually inside a Flash-based player plugin.</p>

<p>Luckily, the issue of how to deal with F4Fs in terms of download has come up in a post on Slashdot not too long ago (see the <a href="http://stackoverflow.com/questions/25425956/any-good-programs-for-handeling-f4f-fragments-and-converting-them-into-a-complet">Slashdot post</a> for more), and somebody has already written a neat little script to do exactly that job of re-assembling the stream fragments.</p>

<p>The script can be run fairly easily on a Linux environment and, with some extra, work possibly also on Windows or Mac OSX, too.</p>

<p>So the following is a step-by-step tutorial on applying the methodology outlined in the post. I have tried to be as concise as possible so as to make it easy to follow, even if you’re not familiar with Linux.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>For this quick tutorial, I have decided to demo the steps involved on a virtual machine running Linux which is hosted in <strong>Koding</strong>: <a href="https://koding.com/">https://koding.com/</a>.</p>

<p>Why? Firstly because I love Koding and secondly because I can do whatver I like in my blog!</p>

<p>But all joking aside, Koding is actually a brilliant project which provides a web-based IDE, collaborative “social” coding, and full (yes, that means <code>root</code> for all the geeks out there) access to your very <strong>own</strong> Ubunutu Linux installation in the cloud, and all that through the browser. This means you are totally free to play with the VM, create, install, delete, do whatever you wish (just don’t do anything harmful, please :-)</p>

<p>Oh yeah, it’s also completely free of charge.</p>

<p>Isn’t that pretty cool??</p>

<p>Simply register for Koding and you’re ready to move on to the first step. Or run the below steps on your local Linux box, VM, etc.</p>

<h2 id="download-the-script">1. Download the script</h2>

<p>After you have familiarized yourself a bit with the Koding environment (they have some pretty good quickstart HOW-TOs), fire up your virtual machine instance. This should automatically open a terminal session, so in your browser you will see the command line as in the below picture:</p>

<p><img src="/images/f4fpost/step1.png" alt="Step 1" /></p>

<p>If you get this far, well done! ;-) Now you can harness the full power of <em>Ubuntu Linux</em>. Awesome.</p>

<p>The first thing I’m going to do is to create a new directory and use <code>git</code> to check out the script’s sources from <em>GitHub</em>:</p>

<pre><code>mkdir video_downloads
cd video_downloads
git clone https://github.com/K-S-V/Scripts.git
</code></pre>

<p>At this stage I should probably mention that when write a</p>

<pre><code>new paragraph in this funny teletype font
</code></pre>

<p>this usually means: These are commands that should be typed and executed in your Linux terminal.</p>

<p>So <code>video_downloads</code> will be our working directory, this way we keep things nice and tidy. I like to keep things nice and tidy.</p>

<h2 id="install-missing-dependencies">2. Install missing dependencies</h2>

<p>Your terminal session should look more or less as in the picture below:</p>

<p><img src="/images/f4fpost/step2a.png" alt="Step 2a" /></p>

<p>Note that I have also run the command</p>

<pre><code>ls -la
</code></pre>

<p>to print a directory listing.</p>

<p>Note further that there is now a <code>Scripts</code> folder, and when you change to that folder using the Linux <code>cd</code> command, you will find a file called <code>AdobeHDS.php</code>. The file ending tells you that the script is written in PHP, and this is the script that’s going to do all the hard work for us!</p>

<pre><code>cd Scripts
</code></pre>

<p>If you now attempt to run the script <em>as is</em>, you’ll quickly notice there is something wrong:</p>

<pre><code>php AdobeHDS.php
</code></pre>

<p>The output will look something like:</p>

<pre><code>            KSV Adobe HDS Downloader

You have to install the following extension(s) to continue: 'curl'
</code></pre>

<p>But that’s easily fixed. We simply use the <code>apt-get</code> command in Ubuntu to install a new software package:</p>

<pre><code>sudo apt-get install php5-curl
</code></pre>

<p><img src="/images/f4fpost/step2b.png" alt="Step 2b" /></p>

<p>Now all is good and we can check that by issuing a quick</p>

<pre><code>php AdobeHDS.php --help
</code></pre>

<p>which shows all of the script’s command line options. Great. let’s move on so.</p>

<h2 id="locating-the-stream-manifest">3. Locating the stream manifest</h2>
<p>For every FLV video that is delivered through F4F chunks, there exists a so-called <strong>stream manifest</strong> file that captures certain technical details of the stream, i.e. quality, length etc., but most importantly the number of chunks, in a machine-readable format.</p>

<p>Our task is to locate the manifest file, because it’s what the script requires as an input.</p>

<p>So now we need to do the following:</p>

<ol>
  <li>Open the web page containing the video you wish to download. Then start the video. This is important.</li>
  <li>Open the browser’s developer console. Dont’ worry, we are not going to break anything, I promise! :-D In Google Chrome this can be achieved either through the menu or by pressing <code>Ctrl+Shift+I</code> simultaneously.</li>
  <li>In the network tab of the developer console you will see how video chunks are constantly downloaded as the video progresses. But you need to look for the manifest. You’ll recognize it once you see it, because the response type is XML and it’s downloaded at the very beginning.</li>
  <li>Copy the link to this file by right-clicking on the name and selecting “Copy Link Address”.</li>
</ol>

<p>Below picture shows an example of how this could look like, highlighting the relevant parts:</p>

<p><img src="/images/f4fpost/step3a.png" alt="Step 3a" /></p>

<p>Your link will of course be totally different from the one I got.</p>

<h2 id="downloading-the-video">4. Downloading the video</h2>

<p>Now we can finally download the video, yay!</p>

<p>I am moving out of the current directory and then I call the script with the manifest file as an input parameter:</p>

<pre><code>cd ..
php Scripts/AdobeHDS.php --manifest https://someserver.com/vod/8dc0b92c3a613889748f7dc3b4f0eab6/8dc0b92c3a613889748f7dc3b4f0eab6.f4m?SUID=195127d33c98c1d9d32842895655b92d
</code></pre>

<p>The download starts, a lot of files are being downloaded, and eventually we get the below output:</p>

<pre><code>ternaryrealm: ~/video_downloads $ php Scripts/AdobeHDS.php --manifest https://someserver.com/vod/8dc0b92c3a613889748f7dc3b4f0eab6/8dc0b92c3a613889748f7dc3b4f0eab6.f4m?SUID=195127d33c98c1d9d32842895655b92d

                    KSV Adobe HDS Downloader

Processing manifest info....
Quality Selection:
Available: 3368 2202 1569 1141 938 646 470
Selected : 3368
Fragments Total: 495, First: 1, Start: 1, Parallel: 8
Downloading 495/495 fragments
Found 396 fragments
Finished
ternaryrealm: ~/video_downloads $
</code></pre>

<p>Cool. Now run the following <code>ls</code> command and it will locate the filename of the <strong>complete video file</strong>:</p>

<pre><code>ls *.flv
e6aaf925d6259bd139c6f53ba4af87dd_fbd5bb249733a6fae16ca0a309d676b5_Seg1-Frag.flv
</code></pre>

<p>This filename looks a bit messy, don’t you agree? I am going to rename the file to <code>video1.flv</code> and move it into a different folder, the <code>Web</code> folder actually, so I will be able to download it from the Koding VM:</p>

<pre><code>mv e6aaf925d6259bd139c6f53ba4af87dd_fbd5bb249733a6fae16ca0a309d676b5_Seg1-Frag.flv ~/Web/video1.flv
</code></pre>

<h2 id="download-the-video-from-koding">5. Download the video from Koding</h2>

<p>All that is left to do now is to download the video file from Koding. That’s the easiest part.</p>

<p>You may not have realized, but your VM already has a <strong>public URL</strong> on the internet. And because we have moved the finished video file into the <code>Web</code> folder, we can now proceed to download it (anything that is in the Web folder can be downloaded over the internet) using that URL.</p>

<ol>
  <li>In your browser window, on the left-hand pane locate the “YOUR VMS” section at the top.</li>
  <li>When hovering the mouse over the VM name, a little menu button is revealed. Click that button.</li>
  <li>This will bring up a dialog window, which, among other things, shows the public URL of the VM. Simply click on that link. This will open a new browser tab.</li>
</ol>

<p>Here are screenshots for the steps described above:</p>

<p><img src="/images/f4fpost/step4b.png" alt="Step 4b" /></p>

<p><img src="/images/f4fpost/step4c.png" alt="Step 4c" /></p>

<p>Now you can download the video by adding the filename <code>video1.flv</code> to the URL:</p>

<p><img src="/images/f4fpost/step4d.png" alt="Step 4d" /></p>

<p>Press enter and the download starts!</p>

<h2 id="cleanup">6. Cleanup</h2>

<p>As you now know, I like to keep things nice and tidy, so finally let’s remove all the downloaded stuff on your Koding VM, or you may eventually run out of disk space:</p>

<pre><code>rm e6*
rm ~/Web/video1.flv
</code></pre>

<p>That’s it folks, enjoy!</p>

  </article>

      <div id="disqus_thread">
      <script type="text/javascript">
          var disqus_shortname = 'warpbreaksblog';
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64533201-1', 'auto');
  ga('send', 'pageview');

</script>

    
</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">warpbreaks.io</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>warpbreaks.io</li>
          <li><a href="mailto:ralph.schlosser@gmail.com">ralph.schlosser@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/bwv988">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">bwv988</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <ul class="description-list footer_description">
           <li>Data, Code and Stuff</li>          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">

      </div>
    </div>

  </div>

</footer>


    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64533201-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>

</html>
